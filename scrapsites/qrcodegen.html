<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Minimal QR Generator + Screen Scanner</title>
<style>
  :root { --bg:#0b1020; --fg:#e6eef6; --muted:#9aa7bd; --accent:#22d3ee; }
  html,body { height:100%; margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial; background:linear-gradient(180deg,#0a1224,#081228); color:var(--fg); }
  .wrap { max-width:980px; margin:20px auto; padding:12px; display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .card { background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.06); border-radius:10px; padding:12px; }
  h2 { margin:0 0 8px 0; font-size:16px; }
  label { display:block; font-size:12px; color:var(--muted); margin-top:8px; }
  input[type=text], input[type=number], select { width:100%; padding:8px; margin-top:6px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:transparent; color:inherit; }
  input[type=color]{ width:36px; height:36px; padding:0; border-radius:50%; border:1px solid rgba(255,255,255,0.1); background:transparent; cursor:pointer; }
  .row { display:flex; gap:8px; }
  .row > * { flex:1; }
  button { background:var(--accent); color:#052; border:none; padding:8px 10px; border-radius:8px; font-weight:700; cursor:pointer; }
  .btn-ghost { background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.08); }
  .actions { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
  .muted { color:var(--muted); font-size:12px; }
  canvas { background:#fff; border-radius:8px; width:100%; height:auto; max-height:420px; }
  video { width:100%; max-height:420px; border-radius:8px; background:#000; }
  .result { margin-top:8px; word-break:break-all; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:rgba(255,255,255,0.03); }
  .tiny { font-size:11px; color:var(--muted); }
  @media (max-width:900px){ .wrap{ grid-template-columns:1fr; } }
</style>
</head>
<body>
<div class="wrap">
  <!-- Generator -->
  <section class="card">
    <h2>Generate</h2>
    <div class="muted">Create a QR with size, colors, error correction, and optional logo overlay.</div>

    <label>Text / URL</label>
    <input id="text" type="text" placeholder="https://example.com" value="https://example.com">

    <div class="row">
      <div>
        <label>Size (px)</label>
        <input id="size" type="number" min="128" max="2048" value="512">
      </div>
      <div>
        <label>Error correction</label>
        <select id="ec">
          <option value="L">L — 7%</option>
          <option value="M" selected>M — 15%</option>
          <option value="Q">Q — 25%</option>
          <option value="H">H — 30%</option>
        </select>
      </div>
    </div>

    <div class="row" style="align-items:center">
      <div>
        <label>Foreground</label>
        <input id="fg" type="color" value="#000000">
      </div>
      <div>
        <label>Background</label>
        <input id="bg" type="color" value="#ffffff">
      </div>
    </div>

    <label>Embed logo</label>
    <input id="logoFile" type="file" accept="image/*">
    <div class="row" style="align-items:center">
      <div>
        <label>Logo scale (%)</label>
        <input id="logoSize" type="number" min="10" max="50" value="20">
      </div>
      <div><label>&nbsp;</label><button id="generate">Generate</button></div>
    </div>

    <div class="actions">
      <button id="downloadPng">Download PNG</button>
      <button id="downloadSvg" class="btn-ghost">Download SVG</button>
      <button id="copyData" class="btn-ghost">Copy text</button>
    </div>

    <div style="margin-top:10px">
      <canvas id="qrCanvas" width="512" height="512"></canvas>
    </div>
    <div class="tiny">Tip: Higher error correction helps scannability if a logo covers the center of the code.</div>
  </section>

  <!-- Scanner -->
  <section class="card">
    <h2>Scan</h2>
    <div class="muted">Share your screen to scan QR codes in other tabs or windows.</div>

    <div class="actions">
      <button id="startScreen">Start Screen Scan</button>
      <button id="stopScan" class="btn-ghost">Stop</button>
    </div>

    <div style="margin-top:10px">
      <video id="screenVideo" playsinline muted></video>
      <canvas id="scanCanvas" style="display:none"></canvas>
    </div>

    <div class="result" id="scanResult" style="display:none"></div>
    <div class="actions" id="resultActions" style="display:none">
      <button id="copyResult" class="btn-ghost">Copy</button>
      <button id="openResult">Open</button>
      <button id="clearResult" class="btn-ghost">Clear</button>
    </div>

    <div class="tiny" style="margin-top:8px">
      Uses the native Barcode Detection API when available, and falls back to jsQR image decoding if not supported.
    </div>
  </section>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
  // --- Generator elements ---
  const textEl   = document.getElementById('text');
  const sizeEl   = document.getElementById('size');
  const ecEl     = document.getElementById('ec');
  const fgEl     = document.getElementById('fg');
  const bgEl     = document.getElementById('bg');
  const logoFileEl = document.getElementById('logoFile');
  const logoSizeEl = document.getElementById('logoSize');
  const genBtn   = document.getElementById('generate');
  const canvas   = document.getElementById('qrCanvas');
  const ctx      = canvas.getContext('2d');

  let logoImage = null;

  logoFileEl.addEventListener('change', (e) => {
    const f = e.target.files?.[0];
    if (!f) { logoImage = null; return; }
    const r = new FileReader();
    r.onload = (ev) => {
      const img = new Image();
      img.onload = () => logoImage = img;
      img.src = ev.target.result;
    };
    r.readAsDataURL(f);
  });

  async function renderQR() {
    const value = textEl.value.trim();
    const size  = Math.max(128, Math.min(2048, Number(sizeEl.value)||512));
    const ec    = ecEl.value;
    const fg    = fgEl.value;
    const bg    = bgEl.value;

    canvas.width = size;
    canvas.height = size;

    if (!value) {
      ctx.clearRect(0,0,size,size);
      return;
    }

    // Draw a white background first
    ctx.fillStyle = bg;
    ctx.fillRect(0,0,size,size);

    // Render QR via data URL, then draw to canvas
    const opts = { errorCorrectionLevel: ec, margin: 1, width: size, color: { dark: fg, light: bg } };
    const dataUrl = await QRCode.toDataURL(value, opts);
    const img = new Image();
    await new Promise(res => { img.onload = res; img.src = dataUrl; });
    ctx.drawImage(img, 0, 0, size, size);

    // Optional logo overlay
    if (logoImage) {
      const s = Math.max(10, Math.min(50, Number(logoSizeEl.value)||20)) / 100;
      const w = size * s, h = size * s, x = (size - w) / 2, y = (size - h) / 2;
      ctx.drawImage(logoImage, x, y, w, h);
    }
  }

  genBtn.addEventListener('click', renderQR);
  ['input','change'].forEach(ev =>
    [textEl,sizeEl,ecEl,fgEl,bgEl,logoSizeEl].forEach(el =>
      el.addEventListener(ev, () => { clearTimeout(renderQR._t); renderQR._t = setTimeout(renderQR, 200); })
    )
  );

  document.getElementById('downloadPng').addEventListener('click', () => {
    const link = document.createElement('a');
    link.download = 'qrcode.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  });

  document.getElementById('downloadSvg').addEventListener('click', async () => {
    const value = textEl.value.trim();
    if (!value) return;
    const ec = ecEl.value, fg = fgEl.value, bg = bgEl.value;
    const svg = await QRCode.toString(value, { type:'svg', errorCorrectionLevel: ec, color: { dark: fg, light: bg } });
    const blob = new Blob([svg], { type:'image/svg+xml' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.download = 'qrcode.svg';
    link.href = url;
    link.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('copyData').addEventListener('click', () => {
    navigator.clipboard.writeText(textEl.value||'');
  });

  // Initial render
  renderQR();

  // --- Scanner ---
  const startBtn = document.getElementById('startScreen');
  const stopBtn  = document.getElementById('stopScan');
  const videoEl  = document.getElementById('screenVideo');
  const scanCanvas = document.getElementById('scanCanvas');
  const scanCtx  = scanCanvas.getContext('2d');
  const resultEl = document.getElementById('scanResult');
  const actionsEl = document.getElementById('resultActions');
  const copyResultBtn = document.getElementById('copyResult');
  const openResultBtn = document.getElementById('openResult');
  const clearResultBtn = document.getElementById('clearResult');

  let scanStream = null;
  let rafId = 0;
  let detector = null;
  let useNativeDetector = false;

  function showResult(text){
    resultEl.textContent = text||'';
    resultEl.style.display = text ? 'block' : 'none';
    actionsEl.style.display = text ? 'flex' : 'none';
  }

  function stopScan(){
    cancelAnimationFrame(rafId);
    if (scanStream) {
      scanStream.getTracks().forEach(t=>t.stop());
      scanStream = null;
    }
    videoEl.srcObject = null;
  }

  async function scanLoop(){
    if (!videoEl.videoWidth || !videoEl.videoHeight) {
      rafId = requestAnimationFrame(scanLoop);
      return;
    }

    try {
      if (useNativeDetector && detector) {
        const barcodes = await detector.detect(videoEl);
        if (barcodes && barcodes.length) {
          showResult(barcodes[0].rawValue || '');
          stopScan();
          return;
        }
      } else {
        // Fallback with jsQR
        const w = videoEl.videoWidth;
        const h = videoEl.videoHeight;
        scanCanvas.width = w;
        scanCanvas.height = h;
        scanCtx.drawImage(videoEl, 0, 0, w, h);
        const imgData = scanCtx.getImageData(0, 0, w, h);
        const code = jsQR(imgData.data, w, h);
        if (code && code.data) {
          showResult(code.data);
          stopScan();
          return;
        }
      }
    } catch (e) {
      // ignore frame decode errors
    }
    rafId = requestAnimationFrame(scanLoop);
  }

  async function startScreenScan(){
    showResult('');
    stopScan();

    try {
      // Request user to pick a screen/window/tab to share
      scanStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
      videoEl.srcObject = scanStream;
      await videoEl.play();

      // Attempt native BarcodeDetector (QR only)
      useNativeDetector = 'BarcodeDetector' in window;
      detector = null;
      if (useNativeDetector) {
        try {
          const supported = await window.BarcodeDetector.getSupportedFormats();
          if (!supported || !supported.includes('qr_code')) {
            useNativeDetector = false;
          } else {
            detector = new window.BarcodeDetector({ formats: ['qr_code'] });
          }
        } catch {
          useNativeDetector = false;
        }
      }

      rafId = requestAnimationFrame(scanLoop);
    } catch (err) {
      // User cancelled or not allowed
      stopScan();
    }
  }

  startBtn.addEventListener('click', startScreenScan);
  stopBtn.addEventListener('click', stopScan);

  copyResultBtn.addEventListener('click', () => {
    if (resultEl.textContent) navigator.clipboard.writeText(resultEl.textContent);
  });
  openResultBtn.addEventListener('click', () => {
    const v = resultEl.textContent || '';
    if (v) window.open(v, '_blank', 'noopener');
  });
  clearResultBtn.addEventListener('click', () => showResult(''));
</script>
</body>
</html>
