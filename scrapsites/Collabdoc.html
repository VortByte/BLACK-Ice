<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>CollabSlides Stage 5</title>
<style>
:root {
  --bg:#f5f5f7;--panel:#fff;--accent:#007aff;--border:#ddd;--text:#111;
  font-family:"Inter",system-ui,-apple-system,sans-serif;
}
body{margin:0;background:var(--bg);display:flex;flex-direction:column;height:100vh;}
header{
  display:flex;justify-content:space-between;align-items:center;
  background:var(--panel);border-bottom:1px solid var(--border);
  padding:8px 12px;
}
header button{
  border:none;background:var(--accent);color:white;padding:6px 10px;
  border-radius:8px;cursor:pointer;font-weight:500;
}
#toolbar{display:flex;gap:8px;background:var(--panel);border-bottom:1px solid var(--border);padding:6px;}
#toolbar select,#toolbar button{
  border:1px solid var(--border);border-radius:6px;padding:4px 8px;cursor:pointer;background:white;
}
#editor{flex:1;padding:16px;overflow-y:auto;background:var(--panel);outline:none;}
#callPane,#linkPane{
  position:fixed;top:0;right:-320px;width:300px;height:100%;
  background:var(--panel);border-left:1px solid var(--border);
  transition:right 0.3s ease;padding:10px;overflow-y:auto;z-index:100;
}
#callPane.active,#linkPane.active{right:0;}
.paneHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.paneHeader button{background:transparent;border:none;font-size:18px;cursor:pointer;color:var(--accent);}
video{width:100%;border-radius:8px;background:#000;}
.status{font-size:14px;font-weight:500;}
.status.connected{color:green;}
.status.disconnected{color:red;}
</style>
</head>
<body>

<header>
  <div>
    <b>Collab Slides</b> | <span id="status" class="status disconnected">ðŸ”´ Disconnected</span>
  </div>
  <div>
    <button id="createRoom">Create Room</button>
    <button id="joinRoom">Join Room</button>
    <button id="toggleLinkPane">ðŸ”— Links</button>
    <button id="toggleCallPane">ðŸ“ž Call</button>
  </div>
</header>

<div id="toolbar">
  <select id="fontSelect">
    <option value="Inter">Inter</option><option value="serif">Serif</option>
    <option value="monospace">Monospace</option><option value="cursive">Cursive</option>
  </select>
  <button onclick="document.execCommand('bold')">Bold</button>
  <button onclick="document.execCommand('underline')">Underline</button>
  <button onclick="document.execCommand('insertUnorderedList')">â€¢ List</button>
  <button id="insertTable">Table</button>
  <button id="insertLink">Insert Link</button>
  <button onclick="document.execCommand('hiliteColor',false,'yellow')">Highlight</button>
</div>

<div id="editor" contenteditable="true"></div>

<!-- Link viewer -->
<div id="linkPane">
  <div class="paneHeader">
    <h3>Links</h3>
    <button id="closeLinkPane">âœ•</button>
  </div>
  <ul id="linkList"></ul>
</div>

<!-- Video call -->
<div id="callPane">
  <div class="paneHeader">
    <h3>Video / Audio Call</h3>
    <button id="closeCallPane">âœ•</button>
  </div>
  <video id="myVideo" autoplay muted></video>
  <video id="peerVideo" autoplay></video>
  <br>
  <button id="callBtn">Call</button>
  <button id="hangBtn">Hang Up</button>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
// ---------- Helper: Human-style IDs ----------
const animals=["otter","fox","dolphin","lion","panda","falcon","koala","eagle","wolf","tiger"];
const adjectives=["brave","calm","wild","bright","silent","swift","clever","gentle","mighty","happy"];
function randomCode(){return `${adjectives[Math.floor(Math.random()*adjectives.length)]}-${animals[Math.floor(Math.random()*animals.length)]}-${Math.floor(Math.random()*90+10)}`;}

// ---------- Ask username ----------
let username=prompt("Enter your name:")||"User"+Math.floor(Math.random()*1000);

// ---------- UI Elements ----------
const editor=document.getElementById("editor");
const statusEl=document.getElementById("status");
const linkPane=document.getElementById("linkPane");
const callPane=document.getElementById("callPane");

// ---------- PeerJS ----------
let peer, conn, currentRoom;
function updateStatus(state){
  statusEl.textContent=(state?"ðŸŸ¢ Connected":"ðŸ”´ Disconnected");
  statusEl.className="status "+(state?"connected":"disconnected");
}

document.getElementById("createRoom").onclick=()=>{
  const roomCode=randomCode();
  peer=new Peer(roomCode,{debug:2});
  currentRoom=roomCode;
  peer.on("open",id=>{
    alert(`Room Created: ${roomCode}`);
    updateStatus(true);
  });
  peer.on("connection",c=>{
    conn=c;
    conn.on("data",d=>editor.innerHTML=d);
    conn.on("open",()=>updateStatus(true));
    conn.on("close",()=>updateStatus(false));
  });
};

document.getElementById("joinRoom").onclick=()=>{
  const roomCode=prompt("Enter Room Code (e.g. bright-otter-42):");
  if(!roomCode)return;
  peer=new Peer(randomCode(),{debug:2});
  peer.on("open",()=>{
    conn=peer.connect(roomCode);
    conn.on("open",()=>{
      updateStatus(true);
      alert("Connected to room " + roomCode);
    });
    conn.on("data",d=>editor.innerHTML=d);
    conn.on("close",()=>updateStatus(false));
  });
};

editor.addEventListener("input",()=>{
  if(conn && conn.open) conn.send(editor.innerHTML);
});

// ---------- Editor tools ----------
document.getElementById("fontSelect").onchange=e=>{
  document.execCommand("fontName",false,e.target.value);
};
document.getElementById("insertTable").onclick=()=>{
  const r=prompt("Rows?"),c=prompt("Cols?");
  if(!r||!c)return;
  let t="<table border='1' style='border-collapse:collapse;width:100%'>";
  for(let i=0;i<r;i++){t+="<tr>";for(let j=0;j<c;j++)t+="<td>&nbsp;</td>";t+="</tr>";}
  t+="</table>";
  document.execCommand("insertHTML",false,t);
};
document.getElementById("insertLink").onclick=()=>{
  const url=prompt("URL:"),title=prompt("Title:");
  if(!url)return;
  document.execCommand("createLink",false,url);
  const li=document.createElement("li");
  li.innerHTML=`<a href="${url}" target="_blank">${title||url}</a>`;
  document.getElementById("linkList").appendChild(li);
};

// ---------- Toggle panes ----------
document.getElementById("toggleLinkPane").onclick=()=>{linkPane.classList.toggle("active");callPane.classList.remove("active");};
document.getElementById("toggleCallPane").onclick=async()=>{callPane.classList.toggle("active");linkPane.classList.remove("active");if(callPane.classList.contains("active"))await initCamera();};
document.getElementById("closeLinkPane").onclick=()=>linkPane.classList.remove("active");
document.getElementById("closeCallPane").onclick=()=>{callPane.classList.remove("active");stopCamera();};

// ---------- Call subsystem ----------
let myStream,callObj;
async function initCamera(){
  if(myStream)return;
  try{
    myStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    document.getElementById("myVideo").srcObject=myStream;
  }catch(e){alert("Camera access denied.");}
}
function stopCamera(){
  if(myStream){
    myStream.getTracks().forEach(t=>t.stop());
    myStream=null;
    document.getElementById("myVideo").srcObject=null;
  }
}
document.getElementById("callBtn").onclick=()=>{
  const pid=prompt("Enter Peer ID to Call:");
  if(!pid||!peer||!myStream)return alert("Peer not ready or camera off");
  callObj=peer.call(pid,myStream);
  callObj.on("stream",s=>document.getElementById("peerVideo").srcObject=s);
};
document.getElementById("hangBtn").onclick=()=>{
  if(callObj)callObj.close();
  document.getElementById("peerVideo").srcObject=null;
};
peer?.on?.("call",incoming=>{
  if(!myStream)initCamera().then(()=>{
    incoming.answer(myStream);
    incoming.on("stream",s=>document.getElementById("peerVideo").srcObject=s);
  });
});
</script>
</body>
</html>
